{% extends "base.html" %}
{% block body %}
<c-form.card title="Crea tu cuenta">
    {{ planes_data|json_script:"planes-data" }}
    {{ obras_sociales_data|json_script:"obras-sociales-data" }}

    {% verbatim %}
    <div x-data="{
            planesData: {},
            obrasSociales: [],
            planes: [],
            selectedObraSocial: null,
            selectedPlan: null,

            init() {
                // Load data from Django script tags
                const planesDataElement = document.getElementById('planes-data');
                if (planesDataElement) {
                    try {
                        this.planesData = JSON.parse(planesDataElement.textContent);
                    } catch (e) {
                        console.error('Error parsing planes-data JSON:', e);
                    }
                }
                const obrasSocialesDataElement = document.getElementById('obras-sociales-data');
                if (obrasSocialesDataElement) {
                    try {
                        this.obrasSociales = JSON.parse(obrasSocialesDataElement.textContent);
                    } catch (e) {
                        console.error('Error parsing obras-sociales-data JSON:', e);
                    }
                }
            },

            handleObraSocialSelect(item) {
                this.selectedObraSocial = item;
                if (this.selectedObraSocial) {
                    this.planes = (this.planesData[this.selectedObraSocial.value] || []);
                this.selectedPlan = null; // Reset plan selection
                } else {
                    this.planes = [];
                }
                this.selectedPlan = null; // Reset plan selection
            },

            handlePlanSelect(item) {
                this.selectedPlan = item;
            }
        }"
         @obra-social-selected.window="handleObraSocialSelect($event.detail)"
         @plan-selected.window="handlePlanSelect($event.detail)">

        <form method="post" class='space-y-4'>
    {% endverbatim %}
            {% csrf_token %}

            {{ form.non_field_errors }}

            <c-form.field>
              <c-form.label for='email'>{{ form.email.label }}</c-form.label>
                <c-input id='email' name='email' type='email' placeholder='Email' value='{{ form.email.value|default_if_none:"" }}'></c-input>
                <c-form.error>{{ form.email.errors }}</c-form.error>
                <c-form.description>
                  Este será tu nombre de usuario.
                </c-form.description>
            </c-form.field>

            <c-form.field>
              <c-form.label for='password'>Contraseña</c-form.label>
                <c-input id='password' name='password1' type="password" ></c-input>
                <c-form.error>{{ form.password1.errors }}</c-form.error>
            </c-form.field>

            <c-form.field>
              <c-form.label for='dni'>{{ form.dni.label }}</c-form.label>
                <c-input id='dni' name='dni' value='{{ form.dni.value|default_if_none:"" }}'></c-input>
                <c-form.error>{{ form.dni.errors }}</c-form.error>
            </c-form.field>

            <c-form.field>
              <c-form.label for='fecha_nac'>{{ form.fecha_nac.label }}</c-form.label>
                <c-input id='fecha_nac' name='fecha_nac' placeholder="DD/MM/AAAA" value='{{ form.fecha_nac.value|default_if_none:"" }}'></c-input>
                <c-form.error>{{ form.fecha_nac.errors }}</c-form.error>
            </c-form.field>

            <c-form.field>
              <c-form.label for='nro_afiliado'>{{ form.nro_afiliado.label }}</c-form.label>
                <c-input id='nro_afiliado' name='nro_afiliado' value='{{ form.nro_afiliado.value|default_if_none:"" }}'></c-input>
                <c-form.error>{{ form.nro_afiliado.errors }}</c-form.error>
            </c-form.field>

            <!-- Obra Social Select -->
            <c-form.field>
                <c-form.label>Obra Social</c-form.label>
                <c-select
                    event_name="obra-social-selected"
                    items_source="obrasSociales"
                    placeholder="Seleccione una Obra Social"
                    >
                </c-select>
                <input type="hidden" name="obra_social" :value="selectedObraSocial ? selectedObraSocial.value : ''">
                <c-form.error>{{ form.obra_social.errors }}</c-form.error>
            </c-form.field>

            <!-- Plan Select -->
            <c-form.field>
                <c-form.label>Plan</c-form.label>
                <c-select
                    event_name="plan-selected"
                    items_source="planes"
                    placeholder="Seleccione un Plan">
                </c-select>
                <input type="hidden" name="plan" :value="selectedPlan ? selectedPlan.value : ''">
                <c-form.error>{{ form.plan.errors }}</c-form.error>
            </c-form.field>

            <c-button type="submit" class="w-full justify-center">Crear cuenta</c-button>
        </form>
    </div>
</c-form.card>
{% endblock %}
