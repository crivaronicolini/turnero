{% extends 'base.html' %}
{% block content %}
<!-- chat container -->
<div class="w-80 rounded-lg bg-white shadow-lg">
  <!-- Top bar -->
  <div class="relative flex w-full items-center justify-between px-3 py-2">
    <div class="flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
        class="size-6">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M8.625 9.75a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375m-13.5 3.01c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.184-4.183a1.14 1.14 0 0 1 .778-.332 48.294 48.294 0 0 0 5.83-.498c1.585-.233 2.708-1.626 2.708-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018Z">
        </path>
      </svg>
      <div class="font-semibold">Bot Salud</div>
    </div>
  </div>

  <!-- conversation -->
  <div id="chat-conversation" class="flex flex-col-reverse h-96 gap-y-1 overflow-y-auto border-t border-gray-200 p-3 pb-6">
    <!-- Existing messages... -->
    <div class="flex flex-col items-start">
      {% comment %}
      <div class="flex w-fit items-center gap-1 rounded-lg bg-gray-100 px-2 py-2.5 text-sm">
        <div class="size-2 animate-pulse rounded-full bg-gray-300"></div>
        <div class="size-2 animate-pulse rounded-full bg-gray-400 [animation-delay:0.2s]"></div>
        <div class="size-2 animate-pulse rounded-full bg-gray-300 [animation-delay:0.4s]"></div>
      </div>
      {% endcomment %}
    </div>
  </div>

  <!-- chat input form -->
  <form
    id="chat-form"
    hx-post="/agent/chat/"
    hx-swap="afterbegin"
    hx-target="#chat-conversation"
    class="relative flex items-start border-t border-gray-200 bg-gray-100 p-2"
  >
    {% csrf_token %}
    <textarea
      x-data="chatInput()"
      x-init="resize()"
      @input="resize()"
      @keydown="handleKeydown($event)"
      id="chat-input"
      name="message"
      rows="1"
      placeholder="Responder"
      class="flex-1 resize-none self-center overflow-y-hidden rounded-lg border-none bg-gray-100 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
    ></textarea>

    <button type="submit" class="ml-2 flex-shrink-0 self-start cursor-pointer rounded-full p-2 text-blue-600 hover:bg-gray-200">
      <svg class="size-5" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18" stroke-linejoin="round" stroke-linecap="round"></path>
      </svg>
    </button>
  </form>
</div>
{% endblock content %}

{% block script %}
<script>
  // Define the Alpine.js component for the chat input
  document.addEventListener('alpine:init', () => {
    Alpine.data('chatInput', function () {
      return {
        // Auto-resize logic
        resize() {
          const maxHeight = 100;
          this.$el.style.height = 'auto';
          const newHeight = Math.min(this.$el.scrollHeight, maxHeight);
          this.$el.style.height = newHeight + 'px';
          this.$el.style.overflowY = newHeight >= maxHeight ? 'auto' : 'hidden';
        },
        // Submit on Enter, newline on Shift+Enter
        handleKeydown(event) {
          if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            this.$el.closest('form').dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
          }
        }
      }
    })
  });

  // Listen for HTMX event to add user's message to the UI optimistically
  document.getElementById('chat-form').addEventListener('htmx:configRequest', function (evt) {
    const message = evt.detail.parameters.message.trim();
    
    // Don't send a request if the message is empty
    if (!message) {
      evt.preventDefault();
      return;
    }

    // Create the user's chat bubble
    const conversation = document.getElementById('chat-conversation');
    const userBubble = document.createElement('div');
    userBubble.className = 'flex flex-col items-end';
    // Sanitize user input before adding it to the DOM to prevent XSS
    const sanitizedMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    userBubble.innerHTML = `<div class="w-fit max-w-3/4 rounded-lg bg-blue-600/70 px-2 py-1 text-left text-sm text-white whitespace-pre-wrap break-words">${sanitizedMessage}</div>`;

    // Prepend the bubble (because of flex-col-reverse)
    conversation.prepend(userBubble);

    // Clear the textarea for the next message
    const textarea = document.getElementById('chat-input');
    setTimeout(() => {
      textarea.value = '';
      // Trigger a resize to shrink the textarea back down
      textarea.dispatchEvent(new Event('input'));
    }, 0);
  });
</script>
{% endblock script %}
